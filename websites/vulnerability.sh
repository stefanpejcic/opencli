#!/bin/bash
################################################################################
# Script Name: websites/vulnerability.sh
# Description: Scan WP site for vulnerabilities.
# Usage: opencli websites-vulnerability <DOMAIN> [--all]
# Author: Stefan Pejcic
# Created: 27.06.2024
# Last Modified: 12.02.2026
# Company: openpanel.com
# Copyright (c) openpanel.com
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
################################################################################

# Check if jq is installed
if ! command -v jq &> /dev/null; then
  echo "jq could not be found, please install jq to proceed."
  exit 1
fi

usage() {
  echo "Usage: opencli websites-vulnerability <website> OR opencli websites-vulnerability --all"
  exit 1
}


# Function to generate report for a domain
generate_report() {
  local website=$1
  local number=$2
  local total=$3

  local optional_msg=""
  [[ -n "$number" && -n "$total" ]] && optional_msg="$optional_msg [$number of $total]"
  echo "[*] $website $optional_msg"
 
  local json

  domain="${website%%/*}"
  url_path="${website#${domain}}"

  local USERNAME CONTEXT DOCROOT

  OUTPUT=$(opencli domains-whoowns "$domain" --context --docroot)
  USERNAME=$(echo "$OUTPUT" | awk '{print $1}')
  CONTEXT=$(echo "$OUTPUT" | awk '{print $2}')
  DOCROOT=$(echo "$OUTPUT" | awk '{print $3}')

  DOCROOT_PATH=${DOCROOT#/var/www/html/}

  FINAL_PATH="/home/${CONTEXT}/docker-data/volumes/${CONTEXT}_html_data/_data/${DOCROOT_PATH}/${url_path}"

  if [ ! -d "$FINAL_PATH" ]; then
      echo "   - ERROR: Docroot directory does not exist: $FINAL_PATH"
      return 1
  fi

  declare -A result

  # 1. core
  VERSION_FILE="$FINAL_PATH/wp-includes/version.php"
  if [ -f "$VERSION_FILE" ]; then
      WP_VERSION=$(grep "\$wp_version =" "$VERSION_FILE" | cut -d "'" -f2)

      if ! [[ "$WP_VERSION" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
          echo "   - [!] Skipping core: failed to fetch \$wp_version from ${DOCROOT_PATH}${url_path:+/$url_path}/wp-includes/version.php file. Check if file exists."
          return 1
      fi

      echo "   - WP core: $WP_VERSION"
      CORE_URI="https://api.openpanel.com/vulnerability/core/$WP_VERSION"
      response=$(curl -s "$CORE_URI")
      if echo "$response" | jq . >/dev/null 2>&1; then
          result["core_version_$WP_VERSION"]="$response"
      else
          echo "   - [!] Error: failed to fetch data from $CORE_URI. Check URL."
          result["core_version_$WP_VERSION"]="null"
      fi
  fi

  # 2. themes
  THEME_DIR="$FINAL_PATH/wp-content/themes"
  if [ -d "$THEME_DIR" ]; then
      for theme in "$THEME_DIR"/*; do
          if [ -d "$theme" ]; then
              theme_name=$(basename "$theme")
              echo "   - theme: $theme_name"
              THEME_URI="https://api.openpanel.com/vulnerability/theme/$theme_name"
              response=$(curl -s "$THEME_URI")
              if echo "$response" | jq . >/dev/null 2>&1; then
                  result["theme_$theme_name"]="$response"
              else
                  echo "   - [!] Error: failed to fetch data from $THEME_URI. Check URL."
                  result["theme_$theme_name"]="null"
              fi
          fi
      done
  else
      echo "   - [!] Skipping plugins: failed to list themes from ${DOCROOT_PATH}${url_path:+/$url_path}/wp-content/themes/ directory. Check if directory exists."
  fi

  # 3. plugins
  PLUGIN_DIR="$FINAL_PATH/wp-content/plugins"
  if [ -d "$PLUGIN_DIR" ]; then
      for plugin in "$PLUGIN_DIR"/*; do
          if [ -d "$plugin" ]; then
              plugin_name=$(basename "$plugin")
              echo "   - plugin: $plugin_name"
              PLUGIN_URI="https://api.openpanel.com/vulnerability/plugin/$plugin_name"
              response=$(curl -s "$PLUGIN_URI")
              if echo "$response" | jq . >/dev/null 2>&1; then
                  result["plugin_$plugin_name"]="$response"
              else
                  echo "   - [!] Error: failed to fetch data from $PLUGIN_URI. Check URL."
                  result["plugin_$plugin_name"]="null"
              fi
          fi
      done
  else
      echo "   - [!] Skipping plugins: failed to list plugins from ${DOCROOT_PATH}${url_path:+/$url_path}/wp-content/plugins/ directory. Check if directory exists."
  fi


  json="{"
  first=true
  for key in "${!result[@]}"; do
      if [ "$first" = true ]; then
          first=false
      else
          json+=","
      fi
      json+="\"$key\":${result[$key]}"
  done
  json+="}"

  #echo "$json"

  all_success=true
  if echo "$json" | jq -e '.[].core_version?, .[].theme_?, .[].plugin_? | select(. == "null")' >/dev/null 2>&1; then
    all_success=false
  fi

  #TODO: check what is stored!
  local filename="/etc/openpanel/wordpress/vulnerability/$(echo "$website" | sed 's|https\?://||' | sed 's|/|_|g').json"
  mkdir -p "$(dirname "$filename")"
  echo "$json" > "$filename"

  $all_success && echo "  [+] Vulnerability API data saved to $filename" 
}

mkdir -p /etc/openpanel/wordpress/vulnerability/

if [ $# -eq 0 ]; then
  usage
elif [[ "$1" == "-all" || "$1" == "--all" ]]; then

  websites=$(opencli websites-all wordpress)

  if [[ -z "$websites" || "$websites" == "No sites found for type 'wordpress'." ]]; then
    echo "[!] No WordPress sites found in the database or opencli command error."
    exit 1
  fi

  readarray -t website_array <<<"$websites"
  total=${#website_array[@]}

  echo "Starting report generation for $total WordPress site(s)"
  count=0
  for website in $websites; do
    count=$((count + 1))
    generate_report "$website" "$count" "$total"
    echo "---------------------------------------------------"
  done
    echo "DONE"
elif [ $# -eq 1 ]; then
  generate_report "$1"
else
  usage  
fi
